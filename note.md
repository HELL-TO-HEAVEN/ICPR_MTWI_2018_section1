# 笔记

## 原始数据

* 图像
* 图像对应的文本以及文本对应的位置坐标

## 输入数据格式说明

* 一个五维的列表，列表各个维度意义为[批次，[图像宽，图像高，通道数]，文本独热矩阵，预测序列长度，真值序列长度]
* 图像高已经限定为32
* 文本稠密向量为一个长度为n_len的向量，向量的每一维为字符在字典中的index值，不足n_len补零
* 预测序列长度可以直接设成图片宽
* 真值序列长度是文本独热矩阵包含的文本独热向量数
* 训练用图片长宽固定

## 输出数据格式说明

* 一个独热矩阵，需要经过ctc解码之后才能得出原来的文本

## 模型参数来源

arXiv:1507.05717v1  [cs.CV]  21 Jul 2015

## 数据预处理

* 对于竖向文本，先等比放缩使高变为32，然后将图像从上往下切成32x32的若干块再横向拼接
* 彩色图像处理有两种方法：抽取出单独一个颜色通道/将图像灰度化
* 最后将图像和文本打包成tfrecord
* 字典内含字5529个，但是要分5530个类（空白类），以空格表示

## 变长序列变长在哪？

将CNN输出按图片宽度展平，得到一个不定长的序列

## 关于the_labels的输入问题

因为这里loss函数使用的是tf.ctc_batch_cost()，所以输入不是独热向量而是稠密向量，向量的每一维
```
__________________________________________________________________________________________________
Layer (type)                    Output Shape         Param #     Connected to                     
==================================================================================================
input_1 (InputLayer)            (None, 32, 128, 1)   0                                            
__________________________________________________________________________________________________
conv2d_1 (Conv2D)               (None, 32, 128, 64)  640         input_1[0][0]                    
__________________________________________________________________________________________________
max_pooling2d_1 (MaxPooling2D)  (None, 16, 64, 64)   0           conv2d_1[0][0]                   
__________________________________________________________________________________________________
conv2d_2 (Conv2D)               (None, 16, 64, 128)  73856       max_pooling2d_1[0][0]            
__________________________________________________________________________________________________
max_pooling2d_2 (MaxPooling2D)  (None, 15, 63, 128)  0           conv2d_2[0][0]                   
__________________________________________________________________________________________________
conv2d_3 (Conv2D)               (None, 15, 63, 256)  295168      max_pooling2d_2[0][0]            
__________________________________________________________________________________________________
conv2d_4 (Conv2D)               (None, 15, 63, 256)  590080      conv2d_3[0][0]                   
__________________________________________________________________________________________________
max_pooling2d_3 (MaxPooling2D)  (None, 8, 31, 256)   0           conv2d_4[0][0]                   
__________________________________________________________________________________________________
conv2d_5 (Conv2D)               (None, 8, 31, 512)   1180160     max_pooling2d_3[0][0]            
__________________________________________________________________________________________________
batch_normalization_1 (BatchNor (None, 8, 31, 512)   2048        conv2d_5[0][0]                   
__________________________________________________________________________________________________
conv2d_6 (Conv2D)               (None, 8, 31, 512)   2359808     batch_normalization_1[0][0]      
__________________________________________________________________________________________________
batch_normalization_2 (BatchNor (None, 8, 31, 512)   2048        conv2d_6[0][0]                   
__________________________________________________________________________________________________
max_pooling2d_4 (MaxPooling2D)  (None, 4, 15, 512)   0           batch_normalization_2[0][0]      
__________________________________________________________________________________________________
conv2d_7 (Conv2D)               (None, 3, 14, 512)   1049088     max_pooling2d_4[0][0]            
__________________________________________________________________________________________________
permute_1 (Permute)             (None, 14, 3, 512)   0           conv2d_7[0][0]                   
__________________________________________________________________________________________________
time_distributed_1 (TimeDistrib (None, 14, 1536)     0           permute_1[0][0]                  
__________________________________________________________________________________________________
bidirectional_1 (Bidirectional) (None, 14, 512)      2754048     time_distributed_1[0][0]         
__________________________________________________________________________________________________
bidirectional_2 (Bidirectional) (None, 14, 512)      1181184     bidirectional_1[0][0]            
__________________________________________________________________________________________________
dense_1 (Dense)                 (None, 14, 5530)     2836890     bidirectional_2[0][0]            
__________________________________________________________________________________________________
the_labels (InputLayer)         (None, None)         0                                            
__________________________________________________________________________________________________
input_length (InputLayer)       (None, 1)            0                                            
__________________________________________________________________________________________________
label_length (InputLayer)       (None, 1)            0                                            
__________________________________________________________________________________________________
ctc (Lambda)                    (None, 1)            0           dense_1[0][0]                    
                                                                 the_labels[0][0]                 
                                                                 input_length[0][0]               
                                                                 label_length[0][0]               
==================================================================================================
Total params: 12,325,018
Trainable params: 12,322,970
Non-trainable params: 2,048
__________________________________________________________________________________________________
```